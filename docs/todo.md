# 開発計画と進捗管理

## フェーズ1: プロジェクトセットアップ 
- [x] 1.1 開発環境構築
  - [x] Node.js v18以上のインストール確認
  - [x] プロジェクトディレクトリの作成
  - [x] .gitignoreの設定
  - [x] ESLintとPrettierの設定
  - [x] TypeScript設定

- [x] 1.2 依存パッケージのセットアップ
  - [x] 本番パッケージインストール
    ```bash
    npm install express puppeteer @google-cloud/local-auth googleapis
    ```
  - [x] 開発用パッケージインストール
    ```bash
    npm install --save-dev nodemon eslint prettier @types/node typescript ts-node @typescript-eslint/parser @typescript-eslint/eslint-plugin
    ```

- [x] 1.3 プロジェクト構成の作成
  ```
  dynamic-html-to-pdf/
  ├── src/
  │   ├── server.ts          # メインサーバーファイル
  │   ├── services/          # ビジネスロジック
  │   │   ├── calendar.ts    # カレンダー生成
  │   │   ├── pdf.ts        # PDF生成
  │   │   └── drive.ts      # Google Drive操作
  │   ├── middleware/        # ミドルウェア
  │   ├── config/           # 設定ファイル
  │   ├── types/            # 型定義
  │   └── utils/            # ユーティリティ関数
  ├── templates/            # HTMLテンプレート
  │   └── template.html
  ├── tests/               # テストファイル
  └── docs/                # ドキュメント
  ```

## 次のステップ: フェーズ2へ
- [x] 2.1 カレンダー生成機能の実装開始
  - [x] 型定義の作成
  - [x] カレンダー生成ロジックの実装
  - [x] テストケースの作成

- [x] 2.2 PDF生成機能の実装
  - [x] Puppeteerの設定
  - [x] PDF生成ロジックの実装
  - [x] テストケースの作成

- [x] 2.3 Google Drive連携
  - [x] Workload Identity設定
  - [x] Drive API統合
  - [x] アップロード機能実装
  - [x] URL生成処理

## 開発メモ
### 2025-02-20
- プロジェクトの初期設定完了
- TypeScript + ESLint + Prettierの開発環境構築
- ディレクトリ構造の整備
- 必要なパッケージのインストール
- カレンダー生成機能の実装完了
  - 型定義とインターフェースの作成
  - カレンダー生成ロジックの実装
  - Jest環境の構築とテストケース作成
  - テストカバレッジ90%以上達成
- PDF生成機能の実装完了
  - Puppeteerを使用したPDF生成サービスの作成
  - カスタマイズ可能なページ設定オプション追加
  - プレビューHTML生成機能の追加
  - テストカバレッジ94%以上達成
- Google Drive連携機能の実装完了
  - Workload Identity認証の設定
  - Drive APIを使用したファイルアップロード機能
  - ファイル権限の自動設定機能
  - アップロードファイルのURL生成
  - テストの実装と実行
- APIエンドポイントの実装完了
  - PDF生成・アップロードエンドポイント
  - プレビューHTMLエンドポイント
  - バリデーションとエラーハンドリング
  - セキュリティ設定（CORS、helmet）
- ドキュメントの整備完了
  - API仕様書の作成
  - デプロイメントガイドの作成
  - トラブルシューティングガイドの作成
  - AppSheet連携マニュアルの作成
- テストの実装完了
  - エンドツーエンドテスト
    - 基本的なPDF生成フロー
    - プレビュー生成
    - エラーハンドリング
    - Webhook統合
  - セキュリティテスト
    - 認証テスト
    - 入力検証とサニタイズ
    - レート制限
    - ファイルアップロード制限
  - 負荷テスト
    - PDF生成（10並列）
    - プレビュー生成（20並列）
    - テンプレート一覧取得（50並列）

### 2025-02-21
- カレンダー生成機能の実装完了
  - 型定義とインターフェースの作成
  - カレンダー生成ロジックの実装
  - Jest環境の構築とテストケース作成
  - テストカバレッジ90%以上達成

### 使用パッケージのバージョン
- Node.js: v18.x
- TypeScript: 5.7.3
- Express: 最新版
- Puppeteer: 最新版
- ESLint: 9.20.1
- Prettier: 3.5.1

### 開発環境設定
- `npm run dev`: 開発サーバー起動
- `npm run build`: TypeScriptビルド
- `npm run lint`: コード品質チェック
- `npm run format`: コードフォーマット
- `npm test`: テスト実行

### コーディング規約
1. 型安全性を重視
   - 明示的な型定義
   - any型の使用を制限
   - インターフェースの活用

2. エラーハンドリング
   - try-catchによる適切な例外処理
   - エラーログの出力
   - クライアントへの適切なエラーレスポンス

3. コードスタイル
   - ESLintとPrettierに従う
   - 関数は単一責任の原則に従う
   - コメントは必要最小限に

## MVPリリースに向けた優先タスク（2025-02-20現在）

### 即時対応（〜2/21）
- [ ] TypeScript型エラーの修正
  - [ ] GeneratePDFRequestインターフェースの修正
  - [ ] middleware/の型エラー解消
  - [ ] services/の型エラー解消
  - [ ] テストコードの型エラー解消

- [ ] 最小機能セットの動作確認
  - [ ] カレンダー生成機能の基本動作確認
  - [ ] PDF変換の基本動作確認
  - [ ] Google Driveアップロードの基本動作確認
  - [ ] 基本的なエラーケースの確認

- [ ] シンプルな本番デプロイ
  - [ ] Cloud Runへの最小構成デプロイ
  - [ ] 基本的なWorkload Identity設定
  - [ ] AppSheetからの疎通確認

### 次フェーズ（〜2/23）
- [ ] エラーハンドリングの基本実装
  - [ ] 主要なエラーパターンの対応
  - [ ] エラーメッセージの日本語化

- [ ] 基本的な監視の実装
  - [ ] エラーログの収集
  - [ ] 基本的なメトリクスの収集

- [ ] ドキュメントの最小セット作成
  - [ ] AppSheet連携手順書の簡易版
  - [ ] 基本的なトラブルシューティングガイド

### 延期可能なタスク
- [ ] パフォーマンス最適化
- [ ] セキュリティ強化
- [ ] 運用効率化
- [ ] コスト最適化
- [ ] テストの網羅性向上

### 完了したタスク
- [x] カレンダー生成機能の実装
- [x] PDF生成機能の実装
- [x] Google Drive連携機能の実装
- [x] APIエンドポイントの実装
- [x] ドキュメントの整備
- [x] テストの実装

## フェーズ2: 基本機能実装
- [x] 2.1 カレンダー生成機能
  - [x] generateCalendarHTML関数の実装
  - [x] オーバーレイ処理の実装（○、△、◇、×）
  - [x] カレンダーのテストケース作成

- [x] 2.2 PDF生成機能
  - [x] puppeteerセットアップ
  - [x] HTML→PDF変換処理の実装
  - [x] PDFオプション設定（A4、マージン等）
  - [x] エラーハンドリング実装

- [x] 2.3 Google Drive連携
  - [x] Workload Identity設定
  - [x] Drive API統合
  - [x] アップロード機能実装
  - [x] URL生成処理

## フェーズ3: APIエンドポイント実装
- [x] 3.1 Express.jsサーバー構築
  - [x] サーバー基本設定
  - [x] ルーティング設定
  - [x] ミドルウェア実装（エラーハンドリング、ログ）

- [x] 3.2 /generate-pdf エンドポイント
  - [x] リクエストバリデーション
  - [x] レスポンス形式の統一
  - [x] エラーレスポンス設計

## フェーズ4: セキュリティ実装
- [x] 4.1 認証・認可
  - [x] Workload Identity設定
  - [x] IAMポリシー設定
  - [x] AppSheet連携設定

- [x] 4.2 入力検証
  - [x] パラメーターバリデーション
  - [x] サニタイズ処理
  - [x] レートリミット実装

## フェーズ5: テスト実装
- [x] 5.1 単体テスト
  - [x] カレンダー生成テスト
  - [x] PDF生成テスト
  - [x] Drive APIテスト

- [x] 5.2 結合テスト
  - [x] エンドポイントテスト
  - [x] エラーケーステスト
  - [x] パフォーマンステスト

## フェーズ6: デプロイ準備
- [x] 6.1 Cloud Run設定
  - [x] Dockerfileの作成
  - [x] Cloud Buildの設定
  - [x] 環境変数の設定

- [x] 6.2 監視・ロギング
  - [x] Cloud Loggingの設定
  - [x] エラー通知の設定
  - [x] パフォーマンスモニタリング

## フェーズ7: AppSheet連携
- [x] 7.1 AppSheet設定
  - [x] Webhookの設定
  - [x] レスポンス処理の実装
  - [x] エラーハンドリング

## フェーズ8: テスト・検証
- [x] 8.1 総合テスト
  - [x] エンドツーエンドテスト
  - [x] 負荷テスト
  - [x] セキュリティテスト

- [x] 8.2 ドキュメント整備
  - [x] API仕様書の作成
  - [x] デプロイメントガイド
  - [x] トラブルシューティングガイド

## フェーズ9: 本番環境デプロイ
- [ ] 9.1 デプロイ前の最終チェック
  - [ ] 全テストの実行と確認
  - [ ] 型チェックの実行
  - [ ] コードスタイルの確認
  - [ ] セキュリティスキャンの実施

- [ ] 9.2 本番環境の準備
  - [ ] GCPプロジェクト設定の確認
  - [ ] 必要なAPIの有効化確認
  - [ ] Workload Identity設定の確認
  - [ ] IAMポリシーの最終確認

- [ ] 9.3 監視とバックアップ
  - [ ] Cloud Monitoringの設定
  - [ ] アラート通知の設定
  - [ ] バックアップ手順の確認
  - [ ] 緊急連絡先の設定

- [ ] 9.4 本番デプロイ
  - [ ] 環境変数の設定
  - [ ] Cloud Runへのデプロイ
  - [ ] 動作確認
  - [ ] AppSheetとの連携テスト

## フェーズ10: 運用フェーズ
- [ ] 10.1 運用監視
  - [ ] パフォーマンスモニタリング
  - [ ] エラーログの監視
  - [ ] 利用状況の分析

- [ ] 10.2 保守・改善
  - [ ] 定期的なセキュリティアップデート
  - [ ] パフォーマンス最適化
  - [ ] ユーザーフィードバックの収集

## 完了基準
1. すべてのテストが成功すること
2. セキュリティチェックをパスすること
3. パフォーマンス要件を満たすこと
4. ドキュメントが完備されていること

## 注意事項
- コミットメッセージは日本語で具体的に記述
- 各フェーズでのレビューを必須とする
- セキュリティを常に最優先で考慮
- エラーハンドリングは丁寧に実装
